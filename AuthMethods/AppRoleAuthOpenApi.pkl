//===----------------------------------------------------------------------===//
//  Copyright (c) 2025 Javier Cuesta
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//  http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//===----------------------------------------------------------------------===//

extends "@openapi/Document.pkl"

import "@openapi/Schema.pkl"
import "@openapi/Components.pkl"
import "@openapi/HTTPResponse.pkl"

import ".../VaultDataResponse.pkl"
import ".../VaultRequestBody.pkl"
import ".../CommonComponents.pkl"

/// Parameter name in the crud endpoint
local parameterRoleName = "role_name"
local parameterEnginePathName = "engine_path"

info {
  title = "Vault Courier AppRole Authentication API"
  description = "API client for Hashicorp Vault and OpenBao"
  version = "0.2.0"
  license {
    name = "Apache License 2.0"
  }
}

servers {
  new { 
    url = "http://127.0.0.1:8200/v1"
    description = "Default http server url"
  }
  new { 
    url = "https://127.0.0.1:8200/v1"
    description = "Default https server url"
  }
}

tags {
  new {
    name = "approle"
    description = "Authentication method"
  }
}

paths {
  ["/auth/{\(parameterEnginePathName)}/role/{\(parameterRoleName)}"] {
    parameters {
      new {
        name = parameterEnginePathName
        description = "AppRole engine path"
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new {
        name = parameterRoleName
        description = "The name of the approle. Example: \"my-app-role\""
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
    }
    get {
      summary = "Get AppRole properties."
      description = "Reads the properties of an existing AppRole."
      operationId = "auth-read-approle"
      tags {
        "approle"
      }
      responses {
        ["200"] {
          description = "OK"
          content {
            ["application/json"] {
              schema = new Reference {
                `$ref` = "#/components/schemas/ReadAppRoleResponse"
              }
            }
          }
        }
      }
    }
    post {
      summary = "Creates or updates AppRole"
      description = "Creates a new AppRole or updates an existing AppRole. This endpoint supports both create and update capabilities."
      operationId = "auth-create-approle"
      tags {
        "approle"
      }
      requestBody {
        required = true
        content {
          ["application/json"] {
            schema = new Reference {
              `$ref` = "#/components/schemas/AuthCreateAppRoleRequest"
            }
          }
        }
      }
      responses {
        ["204"] {
          description = "OK"
        }
      }
    }
    `delete` {
      summary = "Delete AppRole"
      description = "Deletes an existing AppRole from the auth method."
      operationId = "auth-delete-approle"
      tags {
        "approle"
      }
      responses {
        ["204"] {
          description = "OK"
        }
      }
    }
  }

  ["/auth/{\(parameterEnginePathName)}/role/{\(parameterRoleName)}/role-id"] {
    description = "Reads the role-id of a role"
    parameters {
      new {
        name = parameterEnginePathName
        description = "AppRole engine path"
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new {
        name = parameterRoleName
        description = "The name of the approle. Example: \"my-app-role\""
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
      new Reference {
        `$ref` = "#/components/parameters/WrapTTLHeader"
      }      
    }
    get {
      summary = "Get RoleID"
      description = "Reads the RoleID of an existing AppRole."
      operationId = "auth-read-role-id"
      tags {
        "approle"
      }
      responses {
        ["200"] {
          description = "OK"
          content {
            ["application/json"] {
              schema = new Schema {
                anyOf {
                  new Schema {
                    oneOf {
                      new Reference {
                        `$ref` = "#/components/schemas/ReadAppRoleIdResponse"
                      }
                      new Reference {
                        `$ref` = "#/components/schemas/VaultWrappedResponse"
                      }
                    }
                  }
                  new Schema {
                    type = "object"
                  }
                }
              }
            }
          }
        }
      }
    }
  }

  ["/auth/{\(parameterEnginePathName)}/role/{\(parameterRoleName)}/secret-id"] {
    description = "Generates and issues a new SecretID on an existing AppRole"
    parameters {
      new {
        name = parameterEnginePathName
        description = "AppRole engine path"
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new {
        name = parameterRoleName
        description = "The name of the approle. Example: \"my-app-role\""
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
      new Reference {
        `$ref` = "#/components/parameters/WrapTTLHeader"
      }      
    }
    post {
      summary = "Generate AppRole SecretID"
      description = "Generates and issues a new SecretID on an existing AppRole"
      operationId = "auth-approle-secret-id"
      tags {
        "approle"
      }
      requestBody {
        required = true
        content {
          ["application/json"] {
            schema = new Reference {
              `$ref` = "#/components/schemas/AuthGenerateAppRoleSecretIdRequest"
            }
          }
        }
      }
      responses {
        [HTTPResponse.OK] {
          description = "OK"
          content {
            ["application/json"] {
              schema = new Schema {
                anyOf {
                  new Schema {
                    oneOf {
                      new Reference {
                        `$ref` = "#/components/schemas/GenerateAppRoleSecretIdResponse"
                      }
                      new Reference {
                        `$ref` = "#/components/schemas/VaultWrappedResponse"
                      }
                    }
                  }
                  new Schema {
                    type = "object"
                  }
                }
              }
            }
          }
        }
      }
    }
  }

  ["/auth/{\(parameterEnginePathName)}/role/{\(parameterRoleName)}/secret-id-accessor/lookup"] {
    description = "Reads out the properties of a SecretID via the secret id accessor"
    parameters {
      new {
        name = parameterEnginePathName
        description = "AppRole engine path"
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new {
        name = parameterRoleName
        description = "The name of the approle. Example: \"my-app-role\""
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
    }
    post {
      summary = "Get SecretID properties via accessor"
      description = "Reads out the properties of a SecretID via the secret id accessor"
      operationId = "auth-read-approle-secret-id-with-accessor"
      tags {
        "approle"
      }
      requestBody {
        required = true
        content {
          ["application/json"] {
            schema = new Schema {
              type = "object"
              properties {
                ["secret_id_accessor"] {
                  type = "string"
                }
              }
              required {
                "secret_id_accessor"
              }
            }
          }
        }
      }
      responses {
        ["200"] {
          description = "OK"
          content {
            ["application/json"] {
              schema = new Reference {
                `$ref` = "#/components/schemas/ReadAppRoleSecretIdWithAccessorResponse"
              }
            }
          }
        }
      }
    }
  }

  ["/auth/{\(parameterEnginePathName)}/role/{\(parameterRoleName)}/secret-id-accessor/destroy"] {
    description = "Destroy an AppRole secret ID by its accessor."
    parameters {
      new {
        name = parameterEnginePathName
        description = "AppRole engine path"
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new {
        name = parameterRoleName
        description = "The name of the approle. Example: \"my-app-role\""
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
    }
    post {
      summary = "Destroy an AppRole secret ID by its accessor."
      operationId = "auth-destroy-approle-secret-id-with-accessor"
      tags {
        "approle"
      }
      requestBody {
        required = true
        content {
          ["application/json"] {
            schema = new Schema {
              type = "object"
              properties {
                ["secret_id_accessor"] {
                  type = "string"
                }
              }
              required {
                "secret_id_accessor"
              }
            }
          }
        }
      }
      responses {
        ["204"] {
          description = "OK"
        }
      }
    }
  }

  ["/auth/{\(parameterEnginePathName)}/login"] {
    description = "Issues a Vault token based on the presented credentials. `role_id` is always required; if `bind_secret_id` is enabled (the default) on the AppRole, `secret_id` is required too. Any other bound authentication values on the AppRole (such as client IP CIDR) are also evaluated."
    parameters {
      new {
        name = parameterEnginePathName
        description = "AppRole engine path"
        `in`= "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
    }
    post {
      summary = "Login with AppRole"
      description = "Issues a Vault token based on the presented credentials. `role_id` is always required; if `bind_secret_id` is enabled (the default) on the AppRole, `secret_id` is required too. Any other bound authentication values on the AppRole (such as client IP CIDR) are also evaluated."
      operationId = "auth-approle-login"
      tags {
        "approle"
      }
      requestBody {
        required = true
        content {
          ["application/json"] {
            schema = new Schema {
              type = "object"
              properties {
                ["role_id"] {
                  type = "string"
                }
                ["secret_id"] {
                  type = "string"
                }
              }
              required {
                "role_id"
                "secret_id"
              }
            }
          }
        }
      }
      responses {
        ["200"] {
          description = "OK"
          content {
            ["application/json"] {
              schema = new Reference {
                `$ref` = "#/components/schemas/VaultAuthResponse"
              }
            }
          }
        }
      }
    }
  }
}

components {
  parameters {
    ...CommonComponents.parameters
  }
  schemas {
    ...appRoleComponents.schemas
    ...CommonComponents.schemas
  }
}

hidden appRoleComponents: Components = new {
  schemas {
    ["AuthCreateAppRoleRequest"] = VaultRequestBody.createAppRole

    ["ReadAppRoleResponse"] = (VaultDataResponse) {
      properties {
        ["data"] = (VaultRequestBody.createAppRole) {
          properties {
            ["token_explicit_max_ttl"] {
              type = "integer"
            }
            ["token_period"] {
              type = "integer"
            }
            ["token_ttl"] {
              type = "integer"
            }
            ["token_max_ttl"] {
              type = "integer"
            }
            ["secret_id_ttl"] {
              type = "integer"
            }
          }
        }
      }
    }

    ["ReadAppRoleIdResponse"] = (VaultDataResponse) {
      properties {
        ["data"] {
          properties {
            ["role_id"] {
              type = "string"
            }
          }
          required {
            "role_id"
          }
        }
      }
    }

    ["GenerateAppRoleSecretIdResponse"] = (VaultDataResponse) {
      properties {
        ["data"] {
          properties {
            ["secret_id_accessor"] {
              type = "string"
            }
            ["secret_id"] {
              type = "string"
            }
            ["secret_id_ttl"] {
              type = "integer"
            }
            ["secret_id_num_uses"] {
              type = "integer"
            }
          }
          required {
            "secret_id_accessor"
            "secret_id"
            "secret_id_ttl"
            "secret_id_num_uses"
          }
        }
      }
    }

    ["ReadAppRoleSecretIdWithAccessorResponse"] = (VaultDataResponse) {
      properties {
        ["data"] {
          type = "object"
          properties {
            ["cidr_list"] {
              type = "array"
              items = new Schema {
                type = "string"
              }
            }
            ["creation_time"] {
              type = "string"
              format = "date-time"
            }
            ["expiration_time"] {
              type = "string"
              format = "date-time"
            }
            ["last_updated_time"] {
              type = "string"
              format = "date-time"
            }
            ["metadata"] {
              type = "object"
              format = "kvpairs"
              additionalProperties {
                type = "string"
              }
            }
            ["secret_id_accessor"] {
              type = "string"
            }
            ["secret_id_ttl"] {
              type = "integer"
            }
            ["secret_id_num_uses"] {
              type = "integer"
            }
            ["token_bound_cidrs"] {
              type = "array"
              items = new Schema {
                type = "string"
              }
            }
          }
          required {
            "creation_time"
            "secret_id_accessor"
            "secret_id_ttl"
            "secret_id_num_uses"
          }
        }
      }
    }

    ["AuthGenerateAppRoleSecretIdRequest"] {
      type = "object"
      properties {
        ["token_bound_cidrs"] {
          type = "array"
          description = "Comma-separated string or list of CIDR blocks; if set, specifies blocks of IP addresses which can use the auth tokens generated by this SecretID. Overrides any role-set value but must be a subset."
          items = new Schema {
            type = "string"
          }
        }
        ["cidr_list"] {
          type = "array"
          description = "Comma separated string or list of CIDR blocks enforcing secret IDs to be used from specific set of IP addresses. If secret_id_bound_cidrs is set on the role, then the list of CIDR blocks listed here should be a subset of the CIDR blocks listed on the role."
          items = new Schema {
            type = "string"
          }
        }
        ["metadata"] {
          type = "string"
          description = "Metadata to be tied to the SecretID. This should be a JSON-formatted string containing the metadata in key-value pairs. This metadata will be set on tokens issued with this SecretID, and is logged in audit logs in plaintext."
        }
        ["num_uses"] {
          type = "integer"
          description = "Number of times this SecretID can be used, after which the SecretID expires. A value of zero will allow unlimited uses. Overrides secret_id_num_uses role option when supplied. May not be higher than role's secret_id_num_uses."
        }
        ["ttl"] {
          type = "string"
          description = "Duration in seconds (3600) or an integer time unit (60m) after which this SecretID expires. A value of zero will allow the SecretID to not expire. Overrides secret_id_ttl role option when supplied. May not be longer than role's secret_id_ttl."
        }
      }
    }

    // LIST REQUEST NOT SUPPORTED BY OPENAPI
    // ["ListAppRoleResponse"] {
    //   type = "object"
    //   properties {
    //     ["data"] {
    //       type = "object"
    //       properties {
    //         ["keys"] {
    //           type = "array"
    //           description = "List of roles"
    //           items = new Schema {
    //             type = "string"
    //           }
    //         }
    //       }
    //     }
    //   }
    // }
  }
}