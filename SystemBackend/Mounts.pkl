//===----------------------------------------------------------------------===//
//  Copyright (c) 2025 Javier Cuesta
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//  http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//===----------------------------------------------------------------------===//

module Mounts

amends "@openapi/Document.pkl"
import "@openapi/PathItem.pkl"
import "@openapi/Reference.pkl"
import "@openapi/Schema.pkl"

paths {
  // https://developer.hashicorp.com/vault/api-docs/system/mounts
  ["/sys/mounts/{path}"] {
    description = "Mount a new backend at a new path. Example: KV2"
    parameters {
      new {
        name = "path"
        description = "The path to mount to. Example: \"aws/east\""
        `in` = "path"
        schema {
          type = "string"
        }
        required = true
      }
      new Reference {
        `$ref` = "#/components/parameters/VaultTokenHeader"
      }
    }
    post {
      summary = "Enable a new secrets engine at the given path."
      operationId = "mounts-enable-secrets-engine"
      tags {
        "system"
      }
      requestBody {
        required = true
        content {
          ["application/json"] {
            schema = new Reference {
              `$ref` = "#/components/schemas/MountsEnableSecretsEngineRequest"
            }
          }
        }
      }
      responses {
        ["204"] {
          description = "NoContent"
        }
        ["400"] {
          description = "BadRequest"
          content {
            ["application/json"] {
              schema = new Reference {
                `$ref` = "#/components/schemas/VaultErrorsResponse"
              }
            }
          }
        }
      }
    }
  }
}

components {
  schemas {
    ["MountsEnableSecretsEngineRequest"] {
      type = "object"
      properties {
          ["config"] {
            type = "object"
            description = "Configuration for this mount, such as default_lease_ttl and max_lease_ttl."
            format = "map"
          }
          ["description"] {
            type = "string"
            description = "User-friendly description for this mount."
          }
          ["external_entropy_access"] {
            type = "boolean"
            description = "Whether to give the mount access to Vault's external entropy."
            default = false
          }
          ["local"] {
            type = "boolean"
            description = "Mark the mount as a local mount, which is not replicated and is unaffected by replication."
            default = false
          }
          ["options"] {
            type = "object"
            description = "The options to pass into the backend. Should be a json object with string keys and values."
            format = "kvpairs"
          }
          ["plugin_name"] {
            type = "string"
            description = "Name of the plugin to mount based from the name registered in the plugin catalog."
          }
          ["plugin_version"] {
            type = "string"
            description = "The semantic version of the plugin to use, or image tag if oci_image is provided."
          }
          ["seal_wrap"] {
            type = "boolean"
            description = "Whether to turn on seal wrapping for the mount."
            default = false
          }
          ["type"] {
            type = "string"
            description = "The type of the backend. Example: \"passthrough\""
          }
      }
    }
  }
}